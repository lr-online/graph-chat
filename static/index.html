<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI聊天助手</title>
    <!-- 使用本地静态文件 -->
    <link href="/static/css/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="/static/js/vis-network.min.js"></script>
    <!-- 添加 marked.js -->
    <script src="/static/js/marked.min.js"></script>
    <!-- 添加代码高亮 -->
    <link href="/static/css/github.min.css" rel="stylesheet">
    <script src="/static/js/highlight.min.js"></script>
    <!-- 添加 Mermaid -->
    <script src="/static/js/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
            max-width: 100%;
            margin: 0 auto;
        }

        .chat-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: #333;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header svg {
            width: 20px;
            height: 20px;
            color: #007bff;
        }

        .graph-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            overflow: hidden;
        }

        .graph-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .graph-title {
            font-weight: bold;
            color: #333;
        }

        .graph-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            border: 1px solid #e0e3e9;
            border-radius: 20px;
            padding: 4px 12px;
            flex: 0 1 200px;
        }

        .graph-search input {
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            width: 100%;
        }

        .graph-search button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .graph-search button svg {
            width: 16px;
            height: 16px;
        }

        .graph-search button:hover {
            color: #333;
        }

        #knowledge-graph {
            flex: 1;
            background-color: #fafafa;
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 0;
        }

        #knowledge-graph canvas {
            width: 100% !important;
            height: 100% !important;
            position: absolute;
            top: 0;
            left: 0;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            opacity: 0;
            animation: fadeIn 0.3s ease-in-out forwards;
            position: relative;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        /* 基础消息样式 */
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 12px;
            margin: 0 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            line-height: 1.5;
            font-size: 14px;
            position: relative;
        }

        /* 文本消息样式 */
        .message.user .message-content {
            background-color: #f0f2f5;  /* 更柔和的灰色背景 */
            color: #333;
        }

        .message.assistant .message-content {
            background-color: #fff;  /* 白色背景 */
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 36px;  /* 只给AI消息添加底部padding */
        }

        /* 图片消息样式 */
        .message-content.image-only {
            padding: 0;
            background: none !important;  /* 确保图片消息没有背景 */
            border: none !important;
            box-shadow: none;
            max-width: 300px;
        }

        .image-content {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .image-content img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .image-content img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* 文件消息样式 */
        .file-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .file-content:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        
        .file-content svg {
            width: 16px;
            height: 16px;
            color: #666;
        }
        
        .file-content a {
            color: #333;
            text-decoration: none;
        }
        
        .file-content a:hover {
            text-decoration: underline;
        }

        .topic-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 30px 0;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
            position: relative;
        }

        .topic-divider::before,
        .topic-divider::after {
            content: '';
            flex: 1;
            border-bottom: 2px solid #e9ecef;
        }

        .topic-label {
            margin: 0 15px;
            padding: 5px 15px;
            font-size: 13px;
            color: #666;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .assistant .message-content {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .input-container {
            padding: 16px 20px;
            border-top: 1px solid #eaeaea;
            background: #fff;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
            position: relative;
            min-height: 68px;
            transition: all 0.3s ease;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-start;
            flex-grow: 1;
            background: #fff;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            padding: 8px 16px;
            transition: all 0.3s ease;
            min-height: 44px;
            max-height: 30vh;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .input-wrapper:focus-within {
            background: #fff;
            border-color: #2b7de9;
            box-shadow: 0 2px 6px rgba(43,125,233,0.15);
            transform: translateY(-1px);
        }

        .input-wrapper textarea {
            border: none;
            resize: none;
            flex-grow: 1;
            padding: 6px 8px;
            background: transparent;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.88);
            line-height: 1.5;
            min-height: 28px;
            max-height: calc(30vh - 32px);
            overflow-y: auto;
            font-family: inherit;
            margin: 0;
            outline: none;
        }

        .input-wrapper textarea::placeholder {
            color: #9aa0a6;
            font-size: 14px;
            transition: color 0.2s ease;
        }

        .input-wrapper:focus-within textarea::placeholder {
            color: #bdc1c6;
        }

        /* 自定义滚动条样式 */
        .input-wrapper textarea::-webkit-scrollbar {
            width: 4px;
        }

        .input-wrapper textarea::-webkit-scrollbar-track {
            background: transparent;
        }

        .input-wrapper textarea::-webkit-scrollbar-thumb {
            background: #e8eaed;
            border-radius: 2px;
        }

        .input-wrapper textarea::-webkit-scrollbar-thumb:hover {
            background: #dadce0;
        }

        button {
            padding: 0 20px;
            background-color: #2b7de9;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 42px;
            min-width: 86px;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            user-select: none;
        }

        button:hover {
            background-color: #1a73e8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(26,115,232,0.25);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(26,115,232,0.2);
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .message-timestamp {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            display: block;
        }
        
        .message.user .message-timestamp {
            text-align: right;
        }

        .message-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f0f2f5;
            border-radius: 15px;
            margin: 10px 0;
            width: fit-content;
        }
        
        .typing-indicator span {
            display: block;
            width: 6px;
            height: 6px;
            background-color: #0084ff;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
            animation-fill-mode: both;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .message-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        .typing-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-text {
            color: #666;
            font-size: 14px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            background-color: #28a745;
            color: white;
        }
        
        .connection-status.disconnected {
            background-color: #dc3545;
            color: white;
        }
        
        .connection-status.connecting {
            background-color: #ffc107;
            color: black;
        }

        .connection-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin: 10px 4px;
            transition: all 0.3s ease;
        }

        .connection-indicator.connected {
            background-color: #34a853;
            animation: pulse 2s infinite;
        }

        .connection-indicator.disconnected {
            background-color: #ea4335;
            animation: none;
        }

        .upload-buttons {
            display: flex;
            gap: 8px;
            padding-left: 8px;
            border-left: 1px solid #e8eaed;
            margin-left: 4px;
            align-items: center;
            height: 28px;
        }
        
        .upload-button {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            position: relative;
            opacity: 0.75;
        }
        
        .upload-button:hover {
            background: rgba(32, 33, 36, 0.039);
            opacity: 1;
        }
        
        .upload-button svg {
            width: 16px;
            height: 16px;
            color: #5f6368;
            transition: all 0.2s;
        }

        .upload-button:hover svg {
            color: #202124;
        }
        
        .upload-button input[type="file"] {
            position: absolute;
            width: 0;
            height: 0;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        
        .upload-preview {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .message.user .image-content img {
            max-width: 200px;
            border-radius: 8px;
        }
        
        .message.assistant .image-content img {
            max-width: 300px;
            border-radius: 8px;
        }
        
        .file-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #eaeaea;
            transition: all 0.3s ease;
        }
        
        .file-content:hover {
            background: #f8f9fa;
            border-color: #d0d7de;
        }
        
        .file-content a {
            color: #0366d6;
            text-decoration: none;
        }
        
        .file-content a:hover {
            text-decoration: underline;
        }

        .image-content {
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .image-content img {
            max-width: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .image-content img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* 音频消息样式预留 */
        .audio-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }
        
        /* 视频消息样式预留 */
        .video-content {
            max-width: 400px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Markdown 样式统一 */
        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content blockquote {
            border-left: 4px solid rgba(0, 0, 0, 0.1);
            margin: 8px 0;
            padding-left: 12px;
            color: rgba(0, 0, 0, 0.6);
        }

        /* 复制按钮独立样式 */
        .copy-button {
            padding: 4px;
            border: none;
            background: none;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .copy-button:hover {
            background: #f5f5f5;
            color: #333;
            border-color: #d0d7de;
        }

        /* 复制按钮图标样式 */
        .copy-button svg {
            width: 14px;
            height: 14px;
            stroke-width: 2;
        }
        
        /* 复制成功状态 */
        .copy-button.copied {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #90caf9;
        }

        /* 复制按钮容器 */
        .copy-button-container {
            position: absolute;
            left: 0;
            bottom: 0;
            padding: 6px 8px;
        }

        /* 添加节点高亮相关的样式 */
        .node-highlight {
            transition: opacity 0.3s ease;
        }

        .node-dimmed {
            opacity: 0.2;
        }

        .edge-highlight {
            transition: opacity 0.3s ease;
        }

        .edge-dimmed {
            opacity: 0.1;
        }

        @keyframes pulse {
            0% { 
                opacity: 1;
                box-shadow: 0 0 4px rgba(52,168,83,0.4);
            }
            50% { 
                opacity: 0.6;
                box-shadow: 0 0 8px rgba(52,168,83,0.6);
            }
            100% { 
                opacity: 1;
                box-shadow: 0 0 4px rgba(52,168,83,0.4);
            }
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status">连接中...</div>
    
    <div class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>智能对话</span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="input-container">
                <div class="input-wrapper">
                    <span id="connectionIndicator" class="connection-indicator"></span>
                    <textarea 
                        id="messageInput" 
                        placeholder="输入消息... (Shift + Enter 换行)" 
                        rows="1"
                        data-min-rows="1"
                    ></textarea>
                    <div class="upload-buttons">
                        <label class="upload-button" title="上传图片">
                            <input type="file" accept="image/*" onchange="handleImageUpload(event)" hidden>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </label>
                        <label class="upload-button" title="上传文件">
                            <input type="file" onchange="handleFileUpload(event)" hidden>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="12" y1="18" x2="12" y2="12"/>
                                <line x1="9" y1="15" x2="15" y2="15"/>
                            </svg>
                        </label>
                    </div>
                </div>
                <button id="sendButton" onclick="sendMessage()">
                    <span>发送</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="graph-container">
            <div class="graph-header">
                <div class="graph-title">知识图谱</div>
                <div class="graph-search">
                    <input type="text" id="nodeSearchInput" placeholder="搜索节点...">
                    <button id="searchNode">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="knowledge-graph"></div>
        </div>
    </div>

    <div id="uploadPreview" class="upload-preview" style="display: none;">
        <div class="preview-content">
            <img id="imagePreview" style="display: none;">
            <div id="filePreview" style="display: none;"></div>
        </div>
        <button onclick="cancelUpload()" class="cancel-upload">×</button>
    </div>

    <script>
        console.log('脚本开始执行');
        let ws;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        // 确保DOM元素存在
        let chatMessages, messageInput, sendButton, connectionStatus, connectionIndicator;
        
        function initializeElements() {
            console.log('初始化DOM元素');
            chatMessages = document.getElementById('chatMessages');
            messageInput = document.getElementById('messageInput');
            sendButton = document.getElementById('sendButton');
            connectionStatus = document.getElementById('connectionStatus');
            connectionIndicator = document.getElementById('connectionIndicator');
            
            if (!chatMessages || !messageInput || !sendButton || !connectionStatus || !connectionIndicator) {
                console.error('某些DOM元素未找到:', {
                    chatMessages: !!chatMessages,
                    messageInput: !!messageInput,
                    sendButton: !!sendButton,
                    connectionStatus: !!connectionStatus,
                    connectionIndicator: !!connectionIndicator
                });
                return;
            }

            // 绑定事件监听器
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            console.log('DOM元素初始化和事件绑定完成');
        }

        function connectWebSocket() {
            console.log('开始建立WebSocket连接');
            // 获取当前页面的主机名和端口
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname;
            const port = '9000'; // 或者使用 window.location.port 如果端口与页面端口相同
            
            const wsUrl = `${protocol}//${host}:${port}/ws`; // 添加额外的路径前缀
            console.log('WebSocket连接URL:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            updateConnectionStatus('connecting');

            ws.onopen = function() {
                console.log('WebSocket连接已建立');
                updateConnectionStatus('connected');
                reconnectAttempts = 0;
            };

            // WebSocket 事件处理程序应该在这里定义
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case "message_chunk":
                        await handleMessageChunk(data.data);
                        break;
                    case "message_end":
                        await handleMessageEnd(data.data);
                        break;
                    case "error":
                        showError(data.data);
                        break;
                    case "graph_update":
                        updateKnowledgeGraph(data.data);  // 注意这里改回原来的函数名
                        break;
                }
            };

            ws.onclose = () => {
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        connectWebSocket();
                    }, 3000);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
                updateConnectionStatus('disconnected');
            };
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function updateConnectionStatus(status) {
            connectionStatus.className = 'connection-status ' + status;
            connectionIndicator.className = 'connection-indicator ' + status;
            switch(status) {
                case 'connected':
                    connectionStatus.textContent = '已连接';
                    messageInput.placeholder = '输入消息...';
                    setTimeout(() => connectionStatus.style.opacity = '0', 2000);
                    break;
                case 'disconnected':
                    connectionStatus.textContent = '连接断开';
                    messageInput.placeholder = '连接断开，正在重试...';
                    connectionStatus.style.opacity = '1';
                    break;
                case 'connecting':
                    connectionStatus.textContent = '连接中...';
                    messageInput.placeholder = '正在连接...';
                    connectionStatus.style.opacity = '1';
                    break;
            }
            sendButton.disabled = status !== 'connected';
        }

        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }

        // 自定义 marked 渲染器来处理 Mermaid
        const renderer = new marked.Renderer();
        const originalCodeRenderer = renderer.code.bind(renderer);
        renderer.code = function(code, language) {
            // 检查是否是 mermaid 代码块
            if (language && language.match(/^mermaid/i)) {
                const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                return `<div class="mermaid-loading">图表加载中...</div><pre class="mermaid" id="${id}">${code}</pre>`;
            }
            return originalCodeRenderer(code, language);
        };
        
        // 初始化 Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            timeline: {
                useMaxWidth: false,
                padding: 20
            },
            gantt: {
                titleTopMargin: 25,
                barHeight: 20,
                barGap: 4,
                topPadding: 50,
                sidePadding: 50
            }
        });
        
        // 初始化 marked 配置
        marked.setOptions({
            renderer: renderer,
            highlight: function(code, language) {
                if (language === 'mermaid') return code;
                const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                return hljs.highlight(code, { language: validLanguage }).value;
            },
            langPrefix: 'hljs language-',
            pedantic: false,
            gfm: true,
            breaks: true,
            sanitize: false,
            smartypants: false,
            xhtml: false
        });

        // 渲染 Mermaid 图表
        async function renderMermaidDiagrams(element) {
            const mermaidDivs = element.querySelectorAll('.mermaid');
            for (const div of mermaidDivs) {
                try {
                    const loadingDiv = div.previousElementSibling;
                    if (loadingDiv && loadingDiv.classList.contains('mermaid-loading')) {
                        const id = div.id;
                        const code = div.textContent;
                        
                        // 清空当前内容
                        div.textContent = '';
                        
                        // 尝试渲染图表
                        try {
                            await mermaid.parse(code);  // 先解析检查语法
                            const { svg } = await mermaid.render(id, code);
                            div.innerHTML = svg;
                            console.log('Mermaid 图表渲染成功');
                        } catch (renderError) {
                            console.error('Mermaid 语法错误:', renderError);
                            // 如果渲染失败，显示原始代码
                            div.innerHTML = `<pre><code>${code}</code></pre>`;
                        }
                        
                        // 移除加载提示
                        loadingDiv.remove();
                    }
                } catch (error) {
                    console.error('Mermaid 渲染错误:', error);
                    div.innerHTML = `<div class="error">图表渲染失败: ${error.message}</div>
                                    <pre><code>${div.textContent}</code></pre>`;
                }
            }
        }

        async function typeWriter(element, text) {
            if (!text) {
                console.warn('typeWriter: text is undefined or empty');
                return;
            }
            // 解析 Markdown
            const htmlContent = marked.parse(text);
            // 分段添加 HTML 内容
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const nodes = Array.from(tempDiv.childNodes);
            
            for (const node of nodes) {
                const clone = node.cloneNode(true);
                element.appendChild(clone);
                await new Promise(resolve => setTimeout(resolve, 30));
            }
            
            // 高亮代码块
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
            
            // 渲染 Mermaid 图表
            await renderMermaidDiagrams(element);
        }

        function addMessage(role, content, useTypeWriter = false, topic = '未分类', fileInfo = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-topic', topic);

            const timestamp = formatTimestamp();
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'message-timestamp';
            timestampSpan.textContent = timestamp;
            messageDiv.appendChild(timestampSpan);

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';

            // 先创建内容容器
            const contentContainer = document.createElement('div');
            contentContainer.className = 'content-container';

            if (content.startsWith('[图片]')) {
                messageContentDiv.classList.add('image-only');
                contentContainer.innerHTML = `<div class="image-content"><img src="${fileInfo?.url || ''}" alt="上传的图片"></div>`;
            } else {
                contentContainer.innerHTML = role === 'user' ? `<div>${content}</div>` : marked.parse(content);
            }

            // 先添加内容
            messageContentDiv.appendChild(contentContainer);

            // 添加复制按钮（仅对AI助手的文本消息添加）
            if (role === 'assistant' && !content.startsWith('[图片]') && 
                !content.startsWith('[音频]') && !content.startsWith('[视频]') && 
                !content.startsWith('[文件]')) {
                const copyButtonContainer = document.createElement('div');
                copyButtonContainer.className = 'copy-button-container';
                
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `;
                // 保存要复制的内容
                const textToCopy = content;
                copyButton.onclick = async (e) => {
                    e.stopPropagation();
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        copyButton.classList.add('copied');
                        copyButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        `;
                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                            copyButton.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            `;
                        }, 2000);
                    } catch (err) {
                        console.error('复制失败:', err);
                    }
                };
                copyButtonContainer.appendChild(copyButton);
                messageContentDiv.appendChild(copyButtonContainer);
            }

            messageDiv.appendChild(messageContentDiv);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            // 使用 requestAnimationFrame 确保在DOM更新后滚动
            requestAnimationFrame(() => {
                const lastMessage = chatMessages.lastElementChild;
                lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
            });
        }

        function addTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'message assistant';
            const timestamp = formatTimestamp();
            indicatorDiv.innerHTML = `
                <span class="message-timestamp">${timestamp}</span>
                <div class="message-content">
                    <div class="typing-wrapper">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="typing-text">AI正在思考...</span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicatorDiv);
            scrollToBottom();
            return timestamp;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                // 先添加用户消息到聊天界面
                addMessage('user', message, false);  // 不设置话题，等待AI回复后再设置
                
                // 添加打字机指示器
                const timestamp = addTypingIndicator();
                
                // 发送消息到服务器
                ws.send(JSON.stringify({
                    type: 'text',
                    content: message,
                    file_info: {}
                }));
                
                // 清空输入框
                messageInput.value = '';
                messageInput.style.height = 'auto';
                sendButton.disabled = true;
                setTimeout(() => sendButton.disabled = false, 500);
            }
        }

        // 初始化知识图谱
        let network = null;
        
        function initGraph() {
            const container = document.getElementById('knowledge-graph');
            console.log('初始化知识图谱容器:', container);
            if (!container) {
                console.error('找不到知识图谱容器元素');
                return;
            }

            // 设置容器尺寸
            const graphContainer = container.closest('.graph-container');
            const headerHeight = graphContainer.querySelector('.graph-header').offsetHeight;
            container.style.height = `calc(100% - ${headerHeight}px)`;

            // 检查vis.js是否正确加载
            if (typeof vis === 'undefined') {
                console.error('vis库未加载，等待加载完成后重试');
                setTimeout(initGraph, 1000);
                return;
            }

            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: { size: 12, color: '#333' },
                    borderWidth: 1,
                    shadow: { enabled: true, size: 3, x: 1, y: 1 },
                    fixed: false,
                    mass: 2,
                    physics: true
                },
                edges: {
                    width: 1,
                    color: { color: '#999' },
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                    font: { size: 10, color: '#666', align: 'middle' },
                    smooth: { 
                        enabled: true, 
                        type: 'continuous',
                        roundness: 0.3
                    }
                },
                physics: {
                    stabilization: {
                        enabled: true,
                        iterations: 100,
                        fit: true
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.05,
                        springLength: 200,
                        springConstant: 0.04,
                        damping: 0.09,
                        avoidOverlap: 1
                    },
                    minVelocity: 0.1,
                    maxVelocity: 50,
                    solver: 'barnesHut',
                    timestep: 0.5,
                    adaptiveTimestep: true,
                    enabled: true
                },
                layout: {
                    randomSeed: 42,
                    improvedLayout: true,
                    hierarchical: {
                        enabled: false,
                        sortMethod: 'hubsize'
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 300,
                    zoomView: true,
                    dragView: true,
                    dragNodes: true,
                    keyboard: {
                        enabled: true,
                        bindToWindow: false,
                        speed: { x: 0, y: 0, zoom: 0.1 }  // 只保留缩放功能
                    },
                    multiselect: true,
                    selectable: true,
                    selectConnectedEdges: false,
                    hoverConnectedEdges: true
                },
                configure: false,  // 禁用配置按钮
                groups: {         // 定义节点组样式
                    技术: { color: { background: '#90caf9' } },
                    概念: { color: { background: '#a5d6a7' } },
                    工具: { color: { background: '#ffcc80' } },
                    方法: { color: { background: '#ef9a9a' } }
                },
                autoResize: true,    // 自动调整大小
                height: '100%',      // 使用百分比高度
                width: '100%'       // 使用百分比宽度
            };

            const data = {
                nodes: new vis.DataSet([]),
                edges: new vis.DataSet([])
            };

            console.log('创建网络实例前的配置:', { options, data });
            try {
                network = new vis.Network(container, data, options);
                console.log('网络实例创建完成:', network);
                
                // 添加事件监听
                network.on('stabilizationProgress', function(params) {
                    console.log('布局进度:', params.iterations + '/' + params.total);
                });
                
                network.on('stabilizationIterationsDone', function() {
                    console.log('布局计算完成');
                    network.setOptions({ physics: false });
                    network.fit();
                });
                
                network.on('stabilized', function(params) {
                    console.log('网络已稳定，迭代次数:', params.iterations);
                    network.setOptions({ physics: false });
                });

                // 添加错误处理
                network.on('error', function(err) {
                    console.error('网络错误:', err);
                });

                // 拖动开始时的处理
                network.on('dragStart', function(params) {
                    if (params.nodes.length > 0) {
                        network.setOptions({
                            physics: {
                                enabled: true,
                                barnesHut: {
                                    gravitationalConstant: -1000,
                                    centralGravity: 0.02,
                                    damping: 0.08
                                }
                            }
                        });
                    }
                });
                
                // 拖动结束时的处理
                network.on('dragEnd', function(params) {
                    if (params.nodes.length > 0) {
                        // 给一个小延迟让惯性效果更自然
                        setTimeout(() => {
                            network.setOptions({
                                physics: {
                                    enabled: true,
                                    barnesHut: {
                                        gravitationalConstant: -2000,
                                        centralGravity: 0.05,
                                        damping: 0.09
                                    }
                                }
                            });
                        }, 300);
                    }
                });

                // 添加节点搜索功能
                const searchInput = document.getElementById('nodeSearchInput');
                const searchButton = document.getElementById('searchNode');

                function searchNode() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const allNodes = network.body.data.nodes.get();
                    const foundNode = allNodes.find(node => 
                        node.label.toLowerCase().includes(searchTerm)
                    );

                    if (foundNode) {
                        network.focus(foundNode.id, {
                            scale: 1.2,
                            animation: {
                                duration: 1000,
                                easingFunction: 'easeInOutQuad'
                            }
                        });
                        highlightNode(foundNode.id);
                    }
                }

                searchButton.onclick = searchNode;
                searchInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        searchNode();
                    }
                };

                // 添加节点高亮功能
                let highlightActive = false;
                let activeNode = null;

                function highlightNode(nodeId) {
                    const allNodes = network.body.nodes;
                    const allEdges = network.body.edges;
                    
                    // 获取相连的节点和边
                    const connectedNodes = network.getConnectedNodes(nodeId);
                    const connectedEdges = network.getConnectedEdges(nodeId);
                    
                    // 重置所有节点和边的状态
                    Object.values(allNodes).forEach(node => {
                        node.options.opacity = 0.2;
                    });
                    Object.values(allEdges).forEach(edge => {
                        edge.options.opacity = 0.1;
                    });
                    
                    // 高亮选中的节点和相关节点
                    allNodes[nodeId].options.opacity = 1;
                    connectedNodes.forEach(nodeId => {
                        allNodes[nodeId].options.opacity = 0.8;
                    });
                    
                    // 高亮相关的边
                    connectedEdges.forEach(edgeId => {
                        allEdges[edgeId].options.opacity = 0.8;
                    });
                    
                    highlightActive = true;
                    activeNode = nodeId;
                    
                    network.redraw();
                }

                function resetHighlight() {
                    const allNodes = network.body.nodes;
                    const allEdges = network.body.edges;
                    
                    Object.values(allNodes).forEach(node => {
                        node.options.opacity = 1;
                    });
                    Object.values(allEdges).forEach(edge => {
                        edge.options.opacity = 1;
                    });
                    
                    highlightActive = false;
                    activeNode = null;
                    
                    network.redraw();
                }

                network.on('click', function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        if (activeNode !== nodeId) {
                            highlightNode(nodeId);
                        } else {
                            resetHighlight();
                        }
                    } else {
                        resetHighlight();
                    }
                });

            } catch (e) {
                console.error('创建网络实例失败:', e);
                console.error('错误详情:', e.stack);
            }
        }

        function updateKnowledgeGraph(graphData) {
            console.group('更新知识图谱');
            console.log('更新知识图谱数据:', graphData);
            if (!network || !graphData) {
                console.error('network或graphData无效');
                console.groupEnd();
                return;
            }
            
            try {
                // 临时减小物理引擎强度
                network.setOptions({ 
                    physics: {
                        enabled: true,
                        barnesHut: {
                            gravitationalConstant: -1000,  // 拖动时减小排斥力
                            centralGravity: 0.02,         // 减小向心力
                            springLength: 200,            // 保持弹簧长度
                            springConstant: 0.05,         // 增加弹簧弹性
                            damping: 0.08                 // 减小阻尼增加惯性
                        }
                    }
                });
                
                // 预处理节点数据
                const nodeEntries = Object.entries(graphData.nodes);
                console.log('节点数量:', nodeEntries.length);
                
                const nodes = new vis.DataSet(
                    nodeEntries.map(([id, attrs]) => ({
                        id,
                        label: id,
                        title: attrs.description || id,
                        group: attrs.type || 'default',  // 使用组来设置颜色
                        value: 1,
                        scaling: {
                            min: 16,
                            max: 32
                        },
                        mass: 2,
                        fixed: false
                    }))
                );

                const edges = new vis.DataSet(
                    graphData.edges.map((edge, index) => ({
                        id: index,
                        from: edge.source,
                        to: edge.target,
                        label: edge.relation,
                        length: 200,
                        smooth: {
                            type: 'continuous',
                            roundness: 0.5
                        },
                        width: 1.5
                    }))
                );

                network.setData({ nodes, edges });
                
                // 使用setTimeout让DOM有时间更新
                setTimeout(() => {
                    // 恢复物理引擎参数
                    network.setOptions({ 
                        physics: {
                            enabled: true,
                            barnesHut: {
                                gravitationalConstant: -3000,
                                centralGravity: 0.1,
                                springLength: 150,
                                springConstant: 0.02,
                                damping: 0.15,
                                avoidOverlap: 1
                            },
                            minVelocity: 0.5,
                            maxVelocity: 30,
                            solver: 'barnesHut',
                            timestep: 0.3,
                        }
                    });
                    
                    // 稳定后再次适应视图
                    setTimeout(() => {
                        network.fit({
                            animation: {
                                duration: 500,
                                easingFunction: 'easeInOutQuad'
                            }
                        });
                    }, 500);
                }, 100);

            } catch (e) {
                console.error('设置图谱数据失败:', e);
                console.error('错误详情:', e.stack);
            }
            console.groupEnd();
        }

        let currentAssistantMessage = null;
        
        function handleMessageChunk(chunk) {
            if (!currentAssistantMessage) {
                // 移除打字机指示器
                const typingIndicator = document.querySelector('.typing-wrapper')?.closest('.message');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // 创建新的助手消息元素
                currentAssistantMessage = document.createElement('div');
                currentAssistantMessage.className = 'message assistant';
                currentAssistantMessage.innerHTML = `
                    <span class="message-timestamp">${formatTimestamp()}</span>
                    <div class="message-content"></div>
                `;
                chatMessages.appendChild(currentAssistantMessage);
                // 存储原始文本内容
                currentAssistantMessage.rawContent = '';
            }
            
            // 获取消息内容的DOM元素
            const contentDiv = currentAssistantMessage.querySelector('.message-content');
            if (!contentDiv) {
                console.error('找不到消息内容元素');
                return;
            }
            
            // 追加新的内容到原始文本
            currentAssistantMessage.rawContent += chunk;
            
            // 尝试渲染Markdown
            try {
                contentDiv.innerHTML = marked.parse(currentAssistantMessage.rawContent);
                
                // 高亮新的代码块
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
                
                // 尝试渲染新的Mermaid图表
                renderMermaidDiagrams(contentDiv);
            } catch (error) {
                // 如果Markdown解析失败，至少显示原始文本
                console.warn('Markdown解析失败，显示原始文本:', error);
                contentDiv.textContent = currentAssistantMessage.rawContent;
            }
            
            scrollToBottom();
        }
        
        function handleMessageEnd(data) {
            if (currentAssistantMessage) {
                const contentDiv = currentAssistantMessage.querySelector('.message-content');
                if (!contentDiv) {
                    console.error('找不到消息内容元素');
                    return;
                }
                
                try {
                    // 创建内容容器
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'content-container';
                    contentContainer.innerHTML = marked.parse(currentAssistantMessage.rawContent);
                    
                    // 清空原有内容并添加新的内容容器
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(contentContainer);
                    
                    // 添加复制按钮
                    const copyButtonContainer = document.createElement('div');
                    copyButtonContainer.className = 'copy-button-container';
                    
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button';
                    copyButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    `;
                    // 保存原始内容用于复制
                    const originalContent = currentAssistantMessage.rawContent;
                    copyButton.onclick = async (e) => {
                        e.stopPropagation();
                        try {
                            // 尝试使用现代 Clipboard API
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(originalContent);
                            } else {
                                // 后备方案：创建临时文本区域
                                const textArea = document.createElement('textarea');
                                textArea.value = originalContent;
                                textArea.style.position = 'fixed';
                                textArea.style.left = '-9999px';
                                textArea.style.top = '0';
                                document.body.appendChild(textArea);
                                textArea.focus();
                                textArea.select();
                                try {
                                    document.execCommand('copy');
                                } finally {
                                    document.body.removeChild(textArea);
                                }
                            }
                            copyButton.classList.add('copied');
                            copyButton.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            `;
                            setTimeout(() => {
                                copyButton.classList.remove('copied');
                                copyButton.innerHTML = `
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                `;
                            }, 2000);
                        } catch (err) {
                            console.error('复制失败:', err.message);
                            alert('复制失败，请手动复制文本');
                        }
                    };
                    copyButtonContainer.appendChild(copyButton);
                    contentDiv.appendChild(copyButtonContainer);

                    // 代码高亮
                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightBlock(block);
                    });
                    renderMermaidDiagrams(contentDiv);
                } catch (error) {
                    console.error('最终Markdown渲染失败:', error);
                }
                
                currentAssistantMessage = null;
            }
            
            // 处理调试信息
            if (data.debug_info) {
                const lastUserMessage = chatMessages.querySelector('.message.user:last-of-type');
                if (lastUserMessage) {
                    const aiTopic = data.debug_info.assistant_message?.topic || '未分类';
                    lastUserMessage.setAttribute('data-topic', aiTopic);
                }
            }
        }

        // 使用window.onload确保所有资源都加载完成
        window.onload = function() {
            console.log('页面完全加载完成');
            initializeElements();
            initGraph();  // 先初始化图谱
            connectWebSocket();  // 再建立连接
            initTextarea();  // 初始化文本框
        };

        // 同时保留DOMContentLoaded事件监听
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM内容加载完成');
        });

        // 添加窗口大小改变事件监听
        window.addEventListener('resize', function() {
            if (network) {
                network.fit();
            }
        });

        let currentUpload = null;
        
        function showImagePreview(url) {
            const previewDiv = document.getElementById('uploadPreview');
            const imagePreview = document.getElementById('imagePreview');
            const filePreview = document.getElementById('filePreview');
            
            imagePreview.src = url;
            imagePreview.style.display = 'block';
            filePreview.style.display = 'none';
            previewDiv.style.display = 'block';
        }
        
        function cancelUpload() {
            const previewDiv = document.getElementById('uploadPreview');
            const imagePreview = document.getElementById('imagePreview');
            const filePreview = document.getElementById('filePreview');
            
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            filePreview.style.display = 'none';
            previewDiv.style.display = 'none';
            currentUpload = null;
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('上传失败');
                
                const data = await response.json();
                // 保存当前上传的文件信息
                currentUpload = {
                    type: 'image',
                    url: `/uploads/${data.filename}`,  // 添加完整的URL路径
                    ...data
                };
                
                // 直接发送包含图片信息的消息
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // 添加用户消息到聊天界面
                    addMessage('user', `[图片] ${file.name}`, false, undefined, currentUpload);
                    
                    // 添加打字机指示器
                    const timestamp = addTypingIndicator();
                    
                    // 发送消息
                    ws.send(JSON.stringify({
                        type: 'image',
                        content: file.name,
                        file_info: data
                    }));
                }
            } catch (error) {
                console.error('上传失败:', error);
                alert('上传失败');
            }
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('上传失败');
                
                const data = await response.json();
                
                // 发送包含文件信息的消息
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // 添加用户消息到聊天界面
                    addMessage('user', `[文件] ${file.name}`, false);
                    
                    // 添加打字机指示器
                    const timestamp = addTypingIndicator();
                    
                    ws.send(JSON.stringify({
                        type: 'file',
                        content: file.name,
                        file_info: data
                    }));
                }
            } catch (error) {
                console.error('上传失败:', error);
                alert('上传失败');
            }
        }

        // 添加输入框自动调整高度的功能
        function initTextarea() {
            const textarea = document.getElementById('messageInput');
            
            function adjustHeight() {
                textarea.style.height = 'auto';  // 重置高度
                const scrollHeight = textarea.scrollHeight;
                const maxHeight = window.innerHeight * 0.3;  // 30%的视窗高度
                textarea.style.height = Math.min(scrollHeight, maxHeight) + 'px';
            }
            
            textarea.addEventListener('input', adjustHeight);
            
            // 处理Shift+Enter和Enter键
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (e.shiftKey) {
                        // Shift+Enter: 插入换行符
                        return;
                    } else {
                        // 仅Enter: 发送消息
                        e.preventDefault();
                        sendMessage();
                    }
                }
            });
        }

        function renderMessage(content) {
            try {
                // 将换行符转换为<br>标签，然后再进行Markdown渲染
                const preservedContent = content.replace(/\n/g, '  \n');
                return marked.parse(preservedContent);
            } catch (error) {
                console.error('Markdown渲染失败:', error);
                return content;
            }
        }
    </script>
</body>
</html> 